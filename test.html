<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APIç¼–æ’å¼•æ“ - æµ‹è¯•é¡µé¢</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 16px;
            opacity: 0.9;
        }
        
        .content {
            padding: 30px;
        }
        
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .test-section h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 20px;
        }
        
        .test-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: transform 0.2s;
        }
        
        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .test-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .result {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .success {
            color: #52c41a;
            font-weight: bold;
        }
        
        .error {
            color: #ff4d4f;
            font-weight: bold;
        }
        
        .info {
            background: #e6f7ff;
            border-left: 4px solid #1890ff;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        
        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 10px;
        }
        
        .status.online {
            background: #f6ffed;
            color: #52c41a;
            border: 1px solid #b7eb8f;
        }
        
        .status.offline {
            background: #fff1f0;
            color: #ff4d4f;
            border: 1px solid #ffccc7;
        }
        
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”§ APIç¼–æ’å¼•æ“æµ‹è¯•</h1>
            <p>å¿«é€ŸéªŒè¯ç³»ç»ŸåŠŸèƒ½æ˜¯å¦æ­£å¸¸</p>
        </div>
        
        <div class="content">
            <div class="info">
                <strong>ğŸ“ ä½¿ç”¨è¯´æ˜ï¼š</strong>
                <ol style="margin-left: 20px; margin-top: 10px;">
                    <li>ç¡®ä¿åç«¯æœåŠ¡å·²å¯åŠ¨: <code>cd backend && python3 main.py</code></li>
                    <li>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æµ‹è¯•å„é¡¹åŠŸèƒ½</li>
                    <li>æŸ¥çœ‹æµ‹è¯•ç»“æœç¡®è®¤ç³»ç»Ÿè¿è¡Œæ­£å¸¸</li>
                </ol>
            </div>
            
            <div class="test-section">
                <h2>ğŸ”Œ è¿æ¥çŠ¶æ€æ£€æŸ¥</h2>
                <button class="test-button" onclick="checkConnection()">æ£€æŸ¥åç«¯è¿æ¥</button>
                <span id="status-badge"></span>
                <div id="connection-result" class="result" style="display: none;"></div>
            </div>
            
            <div class="test-section">
                <h2>ğŸ”§ å·¥å…·ç®¡ç†æµ‹è¯•</h2>
                <button class="test-button" onclick="testGetTools()">è·å–å·¥å…·åˆ—è¡¨</button>
                <button class="test-button" onclick="testCreateTool()">åˆ›å»ºæµ‹è¯•å·¥å…·</button>
                <button class="test-button" onclick="createExampleTools()">åˆ›å»ºç¤ºä¾‹å·¥å…·</button>
                <div id="tools-result" class="result" style="display: none;"></div>
            </div>
            
            <div class="test-section">
                <h2>ğŸ“Š å·¥ä½œæµç®¡ç†æµ‹è¯•</h2>
                <button class="test-button" onclick="testGetWorkflows()">è·å–å·¥ä½œæµåˆ—è¡¨</button>
                <button class="test-button" onclick="testCreateWorkflow()">åˆ›å»ºæµ‹è¯•å·¥ä½œæµ</button>
                <div id="workflows-result" class="result" style="display: none;"></div>
            </div>
            
            <div class="test-section">
                <h2>â–¶ï¸ å·¥ä½œæµæ‰§è¡Œæµ‹è¯•</h2>
                <button class="test-button" onclick="testExecuteWorkflow()">æ‰§è¡Œå·¥ä½œæµ</button>
                <div id="execution-result" class="result" style="display: none;"></div>
            </div>
            
            <div class="test-section">
                <h2>ğŸ“š è®¿é—®å®Œæ•´åº”ç”¨</h2>
                <p style="margin-bottom: 15px;">æµ‹è¯•é€šè¿‡åï¼Œå¯åŠ¨å‰ç«¯è®¿é—®å®Œæ•´åº”ç”¨ï¼š</p>
                <button class="test-button" onclick="window.open('http://localhost:5173', '_blank')">æ‰“å¼€å‰ç«¯åº”ç”¨</button>
                <button class="test-button" onclick="window.open('http://localhost:8000/docs', '_blank')">æ‰“å¼€APIæ–‡æ¡£</button>
            </div>
        </div>
    </div>
    
    <script>
        const API_BASE = 'http://localhost:8000';
        let lastWorkflowId = null;
        
        function showResult(elementId, content, isError = false) {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.innerHTML = `<pre class="${isError ? 'error' : 'success'}">${content}</pre>`;
        }
        
        async function checkConnection() {
            const badge = document.getElementById('status-badge');
            try {
                const response = await fetch(`${API_BASE}/`);
                const data = await response.json();
                showResult('connection-result', `âœ… è¿æ¥æˆåŠŸï¼\n\n${JSON.stringify(data, null, 2)}`);
                badge.innerHTML = '<span class="status online">â— åœ¨çº¿</span>';
            } catch (error) {
                showResult('connection-result', `âŒ è¿æ¥å¤±è´¥ï¼\n\né”™è¯¯: ${error.message}\n\nè¯·ç¡®ä¿åç«¯æœåŠ¡å·²å¯åŠ¨: cd backend && python3 main.py`, true);
                badge.innerHTML = '<span class="status offline">â— ç¦»çº¿</span>';
            }
        }
        
        async function testGetTools() {
            try {
                const response = await fetch(`${API_BASE}/api/tools/`);
                const data = await response.json();
                showResult('tools-result', `âœ… è·å–å·¥å…·åˆ—è¡¨æˆåŠŸï¼\n\næ‰¾åˆ° ${data.length} ä¸ªå·¥å…·\n\n${JSON.stringify(data, null, 2)}`);
            } catch (error) {
                showResult('tools-result', `âŒ è·å–å·¥å…·åˆ—è¡¨å¤±è´¥ï¼\n\n${error.message}`, true);
            }
        }
        
        async function testCreateTool() {
            const toolData = {
                name: `æµ‹è¯•å·¥å…·_${Date.now()}`,
                description: "è¿™æ˜¯ä¸€ä¸ªé€šè¿‡æµ‹è¯•é¡µé¢åˆ›å»ºçš„å·¥å…·",
                category: "æµ‹è¯•",
                config: {
                    parameters: [
                        {name: "input", type: "string", required: true}
                    ]
                },
                code: "def execute(inputs, context):\n    return f\"Hello {inputs.get('input', 'World')}\""
            };
            
            try {
                const response = await fetch(`${API_BASE}/api/tools/`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(toolData)
                });
                const data = await response.json();
                showResult('tools-result', `âœ… åˆ›å»ºå·¥å…·æˆåŠŸï¼\n\nå·¥å…·ID: ${data.id}\nå·¥å…·åç§°: ${data.name}\n\n${JSON.stringify(data, null, 2)}`);
            } catch (error) {
                showResult('tools-result', `âŒ åˆ›å»ºå·¥å…·å¤±è´¥ï¼\n\n${error.message}`, true);
            }
        }
        
        async function createExampleTools() {
            showResult('tools-result', 'â³ æ­£åœ¨åˆ›å»ºç¤ºä¾‹å·¥å…·...');
            
            const tools = [
                {
                    name: "HTTP_GETè¯·æ±‚",
                    description: "å‘é€HTTP GETè¯·æ±‚",
                    category: "API",
                    config: {parameters: [{name: "url", type: "string", required: true}]},
                    code: "def execute(inputs, context):\n    import httpx\n    url = inputs.get('url')\n    response = httpx.get(url)\n    return response.json()"
                },
                {
                    name: "æ–‡æœ¬è½¬å¤§å†™",
                    description: "å°†æ–‡æœ¬è½¬æ¢ä¸ºå¤§å†™",
                    category: "æ–‡æœ¬å¤„ç†",
                    config: {parameters: [{name: "text", type: "string", required: true}]},
                    code: "def execute(inputs, context):\n    text = inputs.get('text', '')\n    return text.upper()"
                },
                {
                    name: "æ•°å­¦åŠ æ³•",
                    description: "è®¡ç®—ä¸¤æ•°ä¹‹å’Œ",
                    category: "æ•°æ®å¤„ç†",
                    config: {parameters: [
                        {name: "a", type: "number", required: true},
                        {name: "b", type: "number", required: true}
                    ]},
                    code: "def execute(inputs, context):\n    a = float(inputs.get('a', 0))\n    b = float(inputs.get('b', 0))\n    return a + b"
                }
            ];
            
            let created = 0;
            let failed = 0;
            
            for (const tool of tools) {
                try {
                    await fetch(`${API_BASE}/api/tools/`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(tool)
                    });
                    created++;
                } catch (error) {
                    failed++;
                }
            }
            
            showResult('tools-result', `âœ… åˆ›å»ºå®Œæˆï¼\n\næˆåŠŸ: ${created} ä¸ª\nå¤±è´¥: ${failed} ä¸ª`);
        }
        
        async function testGetWorkflows() {
            try {
                const response = await fetch(`${API_BASE}/api/workflows/`);
                const data = await response.json();
                showResult('workflows-result', `âœ… è·å–å·¥ä½œæµåˆ—è¡¨æˆåŠŸï¼\n\næ‰¾åˆ° ${data.length} ä¸ªå·¥ä½œæµ\n\n${JSON.stringify(data, null, 2)}`);
            } catch (error) {
                showResult('workflows-result', `âŒ è·å–å·¥ä½œæµåˆ—è¡¨å¤±è´¥ï¼\n\n${error.message}`, true);
            }
        }
        
        async function testCreateWorkflow() {
            const workflowData = {
                name: `æµ‹è¯•å·¥ä½œæµ_${Date.now()}`,
                description: "é€šè¿‡æµ‹è¯•é¡µé¢åˆ›å»ºçš„å·¥ä½œæµ",
                nodes: [
                    {
                        id: "node_start",
                        type: "custom",
                        position: {x: 100, y: 100},
                        data: {type: "start", label: "å¼€å§‹", config: {}}
                    },
                    {
                        id: "node_end",
                        type: "custom",
                        position: {x: 100, y: 200},
                        data: {type: "end", label: "ç»“æŸ", config: {output_key: "result"}}
                    }
                ],
                edges: [
                    {id: "edge_1", source: "node_start", target: "node_end"}
                ],
                variables: {test: "value"}
            };
            
            try {
                const response = await fetch(`${API_BASE}/api/workflows/`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(workflowData)
                });
                const data = await response.json();
                lastWorkflowId = data.id;
                showResult('workflows-result', `âœ… åˆ›å»ºå·¥ä½œæµæˆåŠŸï¼\n\nå·¥ä½œæµID: ${data.id}\nå·¥ä½œæµåç§°: ${data.name}\nèŠ‚ç‚¹æ•°: ${data.nodes.length}\n\n${JSON.stringify(data, null, 2)}`);
            } catch (error) {
                showResult('workflows-result', `âŒ åˆ›å»ºå·¥ä½œæµå¤±è´¥ï¼\n\n${error.message}`, true);
            }
        }
        
        async function testExecuteWorkflow() {
            if (!lastWorkflowId) {
                showResult('execution-result', 'âš ï¸ è¯·å…ˆåˆ›å»ºä¸€ä¸ªå·¥ä½œæµï¼', true);
                return;
            }
            
            showResult('execution-result', 'â³ æ­£åœ¨æ‰§è¡Œå·¥ä½œæµ...');
            
            const executionData = {
                workflow_id: lastWorkflowId,
                input_data: {test_input: "Hello World"}
            };
            
            try {
                const response = await fetch(`${API_BASE}/api/execution/run`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(executionData)
                });
                const data = await response.json();
                
                let logsText = '';
                if (data.logs && data.logs.length > 0) {
                    logsText = '\n\næ‰§è¡Œæ—¥å¿—:\n' + data.logs.map(log => 
                        `[${log.level}] ${log.message}`
                    ).join('\n');
                }
                
                showResult('execution-result', 
                    `âœ… å·¥ä½œæµæ‰§è¡ŒæˆåŠŸï¼\n\n` +
                    `æ‰§è¡ŒID: ${data.id}\n` +
                    `çŠ¶æ€: ${data.status}\n` +
                    `è¾“å‡º: ${JSON.stringify(data.output_data, null, 2)}` +
                    logsText
                );
            } catch (error) {
                showResult('execution-result', `âŒ æ‰§è¡Œå·¥ä½œæµå¤±è´¥ï¼\n\n${error.message}`, true);
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥è¿æ¥
        window.onload = function() {
            checkConnection();
        };
    </script>
</body>
</html>
